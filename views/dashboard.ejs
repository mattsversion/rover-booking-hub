<!-- views/dashboard.ejs -->
<h2 style="margin-top:0;">Daily dashboard</h2>

<div class="tabs" style="margin-bottom:10px;">
  <div class="segmented" role="tablist" aria-label="Dashboard sections">
    <button class="active" data-tab="today"   role="tab" aria-selected="true">Today (<%= today.length %>)</button>
    <button data-tab="upcoming" role="tab" aria-selected="false">Next 7 days (<%= upcoming.length %>)</button>
    <button data-tab="stale"    role="tab" aria-selected="false">Pending > 24h (<%= stalePending.length %>)</button>
  </div>
  <div style="margin-left:auto;display:flex;gap:10px;flex-wrap:wrap;">
    <a class="ghost" href="/">Inbox</a>
    <a class="ghost" href="/analytics">Analytics</a>
  </div>
</div>

<%
  function displayName(b){
    return b.contactLabel || b.clientName || b.clientPhone || b.roverRelay || '‚Äî';
  }
  function displayHandle(b){
    return b.clientPhone || b.roverRelay || '';
  }
%>

<% function card(b, tabKey){
     const last = (b.messages||[])[(b.messages||[]).length-1];
     const ended = new Date(b.endAt) < new Date();
%>
  <a class="row card" href="/booking/<%= b.id %>" style="align-items:flex-start; position:relative;">
    <div style="flex:1;">
      <!-- Headline prefers contactLabel, then clientName, then phone/relay -->
      <div style="font-weight:700;"><%= displayName(b) %> ‚Ä¢ <%= b.status %></div>

      <!-- Small line with the raw handle + Copy -->
      <% if (displayHandle(b)) { %>
        <div class="muted" style="margin-top:4px;display:flex;gap:8px;align-items:center;">
          <span><%= displayHandle(b) %></span>
          <button class="ghost" type="button" onclick="copyNumber('<%= displayHandle(b) %>')">Copy</button>
        </div>
      <% } %>

      <div class="muted" style="margin-top:4px;">
        <b>Service:</b> <%= b.serviceType || '‚Äî' %> ‚Ä¢ <b>Dogs:</b> <%= b.dogsCount || 1 %>
      </div>
      <div class="muted"><%= new Date(b.startAt).toLocaleString() %> ‚Üí <%= new Date(b.endAt).toLocaleString() %></div>

      <% if (b.pets && b.pets.length) { %>
        <div class="muted" style="margin-top:6px;">
          <b>Pets:</b>
          <%= b.pets.map(p => (p.name || '') + (p.breed ? (' ¬∑ ' + p.breed) : '')).join(', ') %>
        </div>
      <% } %>
      <% if (b.notes) { %><div style="margin-top:6px;"><%= b.notes %></div><% } %>
      <% if (last?.body) { %><div class="muted" style="margin-top:6px;">last msg: <%= last.body.slice(0,140) %></div><% } %>

      <% if (tabKey !== 'stale' && ended) { %>
        <div class="card" style="margin-top:8px;background:#f8f9ff;border:1px solid #e1e4ff;">
          <div class="muted" style="margin-bottom:6px;">This booking has ended. Delete it from the site?</div>
          <div class="actions" style="gap:8px;">
            <button class="danger" type="button" onclick="return delBooking('<%= b.id %>')">
              üóëÔ∏è Delete
            </button>
            <button class="ghost" type="button" onclick="event.preventDefault();event.stopPropagation();">Keep</button>
          </div>
        </div>
      <% } %>
    </div>
  </a>
<% } %>

<div class="tab-panels">
  <!-- Today -->
  <div class="tab-panel active" id="tab-today">
    <h3>Today</h3>
    <div class="list">
      <% if (!today.length) { %>
        <div class="card muted">Nothing scheduled today.</div>
      <% } %>
      <% today.forEach(b => { %><% card(b, 'today') %><% }) %>
    </div>
  </div>

  <!-- Next 7 days -->
  <div class="tab-panel" id="tab-upcoming">
    <h3>Next 7 days</h3>
    <div class="list">
      <% if (!upcoming.length) { %>
        <div class="card muted">No upcoming bookings in the next week.</div>
      <% } %>
      <% upcoming.forEach(b => { %><% card(b, 'upcoming') %><% }) %>
    </div>
  </div>

  <!-- Stale pending -->
  <div class="tab-panel" id="tab-stale">
    <h3>Pending > 24 hours</h3>
    <div class="list">
      <% if (!stalePending.length) { %>
        <div class="card muted">No stale pending threads.</div>
      <% } %>
      <% stalePending.forEach(b => { %><% card(b, 'stale') %><% }) %>
    </div>
  </div>
</div>

<script>
  function copyNumber(num){
    if(!num) return;
    navigator.clipboard.writeText(num).then(()=>alert('Number copied'));
  }

  const btns = document.querySelectorAll('.segmented button');
  const panels = {
    today:    document.getElementById('tab-today'),
    upcoming: document.getElementById('tab-upcoming'),
    stale:    document.getElementById('tab-stale'),
  };
  function setActive(key){
    btns.forEach(b=>{
      const on = b.dataset.tab===key;
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', String(on));
    });
    Object.entries(panels).forEach(([k,el])=>{
      el.classList.toggle('active', k===key);
    });
  }
  btns.forEach(b => b.addEventListener('click', ()=> setActive(b.dataset.tab)));

  async function delBooking(id){
    if(!confirm('Delete this booking? This cannot be undone.')) return false;
    const res = await fetch('/api/bookings/' + id, { method:'DELETE' });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok){ alert(data.error || 'Delete failed'); return false; }
    location.reload();
    return false;
  }
</script>
